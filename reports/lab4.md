# Lab6

## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 **以下各位** 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

   > *《你交流的对象说明》*
   >
   > 无交流

2. 此外，我也参考了 **以下资料** ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

   > *《你参考的资料说明》*
   >
   > 除实验文档外无其他资料

\3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

\4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。

## 编程作业

`pub fn sys_spawn(_path: *const u8) -> isize`

- 需要稍作更改，因为不是靠loader去物理内存取出可执行文件的二进制数据了，而是靠文件系统在磁盘里面取出数据
- 需要仿照sys_exec里面，使用open_file函数获取_path文件名对应的Inode，然后通过read_all函数读出这个索引节点对应的物理磁盘节点（即文件）里面存的数据

`pub fn sys_fstat(_fd: usize, _st: *mut Stat) -> isize`

- 找到这个文件对应的inode_id

`pub fn sys_linkat(_old_name: *const u8, _new_name: *const u8) -> isize`

- 关于硬连接
    
    硬链接数量通常记录在磁盘中的 inode 节点中。每个文件系统都有自己的数据结构来表示 inode 节点，在这些数据结构中会包含一个字段来记录硬链接数量。这样做的好处是可以保证硬链接数量的一致性，即使文件系统被卸载或重启，硬链接数量也能得到正确的维护
    
    - 基于这一点，在DiskInode中新增属性：
        
        ```rust
        // 硬连接数量，mut
        pub hard_links_num: u32
        ```
        
    - 然后为DiskInode新增函数：硬连接数量++和硬连接数量—以及获取硬连接数量，这样一来就可以通过Inode的modify_disk_inode方法来获取硬连接数，然后每次删除硬连接和建立硬连接的时候修改硬连接数
- 其余的主要就是仿照create就行了，将old_name对应的inode的inode_id和new_name作为参数新建目录项，唯一的区别就是不用去分配inode_id
- 但是我写的这个只能由root_inode调用

`pub fn sys_unlinkat(_name: *const u8) -> isize`

- 思路很简单，就是使用name找到目录项，然后将那个目录项修改为DirEntry::empty()就行了
- 如果inode只剩一个硬连接（最开始建立的那个），就把它的数据块也clear
- 最后inode对应的DiskInode的硬连接数—